# Лабораторная работа №1: базовая настройка PostgreSQL на Debian

Цель: Настроить окружение, установить PostgreSQL в Debian, освоить базовые приёмы администрирования системы и СУБД.

## 1. Подготовка среды

После того как Debian был установлен на виртуальную машину была обновлена система с помощью команд apt-get update и apt-get upgrade. apt-get update обновляет локальный кэш списка доступных пакетов и их версий, а apt-get upgrade устанавливает новые версии уже установленных пакетов на основе текущего кэша метаданных. При обновлении системы всегда сначала выполняется apt-get update для актуализации списка пакетов, затем apt-get upgrade для установки обновлений.

![alt text](image.png)

## 2. Установка PostgreSQL

Был установлен PostgreSQL через репозиторий с помощью пакетного менеджера apt командой sudo apt install postgresql postgresql-contrib. Пакет postgresql включает основной сервер и конфигурационные файлы, а пакет postgresql-contrib предоставляет дополнительные расширения и утилиты.

![alt text](image-1.png)

Также был установлен postgresql-client. Пакет postgresql-client содержит клиентские утилиты для взаимодействия с сервером PostgreSQL, запущенным локально или на удалённой машине.

![alt text](image-2.png)

## 3. Создание служебной учётной записи

Проверка что учётная запись postgres была успешно создана с помощью команды для доступа к командной строке Postgres.

![alt text](image-4.png)

Учётная запись postgres в Debian — это системный пользователь, создаваемый пакетом postgresql-common при установке PostgreSQL.

Основные права и возможности учетной записи postgres:

- Полный контроль (Superuser): Может обходить любые проверки прав доступа, включая GRANT, REVOKE и ALTER DEFAULT PRIVILEGES.
- Управление объектами: Владелец или создатель большинства объектов в системных схемах по умолчанию.
- Управление базами данных: Может создавать, изменять и удалять любые базы данных (DROP/CREATE DATABASE).
- Управление ролями: Создание, изменение, удаление пользователей и групп (CREATE/DROP ROLE).
Назначение:
- Администрирование: Основная учетная запись для настройки сервера, резервного копирования и управления безопасностью.
- Первичная настройка: Используется для создания других ролей и баз данных сразу после установки.

Права и назначение этой учётной записи определены архитектурой безопасности СУБД.

## 4. Первичная настройка конфигурационных файлов

Далее с помощью nano были открыты основные файлы конфигурации postgresql.conf и pg_hba.conf которые находятся по пути /ect/postgresql/15/main/. В файл pg_hba.conf был отключен метод аутентификации путём замены peer на trust. Метод peer выполняет аутентификацию через имя системного пользователя ОС. Подключение к PostgreSQL от имени роли postgres разрешается только тогда, когда системный пользователь также называется postgres. Метод trust отключает аутентификацию полностью. Любое локальное подключение через Unix-сокет будет разрешено без проверки учётных данных.

![alt text](image-8.png)

![alt text](image-5.png)

![alt text](image-6.png)

![alt text](image-7.png)

## 5. Управление сервисом

Был проверен статус и был включен автозапуск PostgreSQL с помощью systemctl. systemctl - это утилита командной строки для управления системой и службами в Linux-дистрибутивах, использующих систему инициализации systemd. Видно, что служба активна.

![alt text](image-9.png)

## 6. Создание тестовой базы данных

В PostgreSQL через суперпользователя был создан отдельный пользователь bainazarovei и база данных dbbainazarovei. Был задан пароль пользователю bainazarovei.

![alt text](image-3.png)

![alt text](image-10.png)

С помощью команды \du было проверено наличие пользователя

![alt text](image-11.png)

![alt text](image-12.png)

## 7. Знакомство со схемами

Создание новой схемы с помощью CREATE SCHEMA и установка прав пользователю на использование схемы с помощью GRANT.

![alt text](image-13.png)

Проверка текущего пути.

![alt text](image-14.png)

Смена search_path для сессии чтобы обращаться к таблицам без указания имени схемы.

![alt text](image-15.png)

Смена search_path для пользователя.

![alt text](image-16.png)

В PostgreSQL база данных и схема — это два разных уровня изоляции объектов. База данных — это независимый контейнер на уровне кластера СУБД. Каждая база данных имеет собственное пространство имён, системные каталоги и набор объектов. Схема — это логический контейнер внутри одной базы данных. Она группирует объекты: таблицы, представления, функции, типы. Одна база данных может содержать множество схем.

## 8. Использование утилиты psql для базовых операций

Создание таблицы в схеме public с помощью запроса CREATE TABLE.

![alt text](image-17.png)

SQL-запросы SELECT, INSERT, UPDATE, DELETE.

![alt text](image-18.png)

![alt text](image-19.png)

Создание таблицы в схеме test_schema с помощью запроса CREATE TABLE с привязкой к конкретиной схеме.

![alt text](image-20.png)

SQL-запросы SELECT, INSERT, UPDATE, DELETE.

![alt text](image-21.png)

![alt text](image-22.png)

## 9. Настройка локальных и сетевых подключений

Определение внутреннего IP сервера для настройки доступа к базе данных по локальной сети с помощью ip a.

![alt text](image-23.png)

Смена параметра listen_addresses на конкретный внутренний IP сервера, который определяет, на каких сетевых интерфейсах сервер будет принимать подключения.

![alt text](image-24.png)

Смена адреса в правилах аутентификации, чтобы разрешались подключения с локальной сети. Каждая строка определяет правило доступа. Формат: тип-база-пользователь-адрес-метод.

![alt text](image-26.png)

После изменения обоих файлов был перезапущен PostgreSQL. Был установлен ufw и было задано разрешение входящих подключений на порт.

![alt text](image-25.png)

![alt text](image-27.png)

Был изменён тип подключения на сетевой мост в настройках виртуальной машины.

![alt text](image-28.png)

В настройках подключения DBeaver был указан внутренний IP сервера, база данных dbbainazarovei, пользователь bainazaroei и пароль.

![alt text](image-29.png)

## 10. Журналирование (logging)

Для изменения настроек журналирования был открыт файл postgresql.conf и были заданы определённые параметры:

- `logging_collector` включает сборщик логов, который перенаправляет stderr в файлы. Значение `on` активирует запись в файлы вместо syslog.
- `log_directory` указывает директорию для логов относительно data directory PostgreSQL.
- `log_filename` определяет формат имени файла. Указанный шаблон создаст файлы с датой и временем в имени, что удобно для ротации.
- `log_statement` со значением `all` записывает все SQL-запросы. Другие варианты: `none`, `ddl` (только DDL-команды), `mod` (DDL плюс INSERT/UPDATE/DELETE). Для продакшена `all` создаст большой объем логов, но для отладки это полезно.
- `log_connections` и `log_disconnections` записывают события подключения и отключения клиентов.
- `log_duration` добавляет время выполнения каждого запроса.
- `log_line_prefix` форматирует префикс каждой строки лога. Используемые подстановки: `%t` — timestamp, `%p` — process ID, `%l` — номер строки лога, `%u` — имя пользователя, `%d` — база данных, `%a` — имя приложения, `%h` — хост клиента.
- `log_min_duration_statement` со значением `0` логирует все запросы независимо от времени выполнения.

![alt text](image-30.png)

![alt text](image-31.png)

![alt text](image-32.png)

Были просмотрены логи по пути /var/log/postgresql/postgresql-15-main.log.

![alt text](image-33.png)

## 11. Назначение ролей и прав

Был создан пользователь с ограниченными привелегиями limited_user (только с правом входа и пароля) с помощью запроса WITH LOGIN PASSWORD.

![alt text](image-34.png)

Роль не имеет права читать данные из таблицы, хотя может подключаться к базе.

![alt text](image-35.png)

Пользователю limited_user были выданы права на использование SELECT с помощью GRANT. Команда GRANT используется для предоставления привилегий на объекты базы данных.

![alt text](image-36.png)

От имени limited_user были проверены права. Видно, что пользователь может использовать запрос SELECT, но не может использовать другие запросы.

![alt text](image-37.png)

Далее была создана группа ролей readers, которой были выданы права на использование SELECT. Для проверки наследования ролей был создан пользователь reader1 с ключевым словом INHERIT, которая означает, что роль автоматически получает все привилегии ролей, членом которых она является. Это поведение по умолчанию.

![alt text](image-38.png)

Видно, что пользователь может использовать запрос SELECT, но не может использовать другие запросы.

![alt text](image-39.png)
